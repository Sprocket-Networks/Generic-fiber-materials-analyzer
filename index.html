<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiber - FTTX Materials Analyzer Template</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --surface: #ffffff;
  --surface2: #f7f8fa;
  --border: #e0e3e8;
  --border-light: #ebedf0;
  --text: #1a1d26;
  --text-dim: #5a5f72;
  --text-muted: #9198a8;
  --accent: #2563eb;
  --accent-light: #3b82f6;
  --accent-bg: rgba(37,99,235,0.08);
  --green: #059669;
  --green-bg: rgba(5,150,105,0.08);
  --blue: #2563eb;
  --blue-bg: rgba(37,99,235,0.08);
  --orange: #d97706;
  --orange-bg: rgba(217,119,6,0.08);
  --red: #dc2626;
  --red-bg: rgba(220,38,38,0.08);
  --purple: #7c3aed;
  --purple-bg: rgba(124,58,237,0.08);
  --teal: #0d9488;
  --teal-bg: rgba(13,148,136,0.08);
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* TOP NAV */
.topnav {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  height: 56px;
  gap: 20px;
  position: sticky; top:0; z-index: 100;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.topnav-brand {
  display:flex; align-items:center; gap:10px;
  font-weight:700; font-size:15px; color:var(--text);
  white-space: nowrap;
}
.topnav-brand .icon {
  width:28px; height:28px; border-radius:6px;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  display:flex; align-items:center; justify-content:center;
  color:white; font-size:14px; font-weight:700;
}
.topnav-tabs { display:flex; gap:2px; background:var(--surface2); border-radius:var(--radius-sm); padding:3px; }
.topnav-tab {
  padding: 6px 16px; border-radius: 6px;
  font-size:13px; font-weight:500; color:var(--text-dim);
  cursor:pointer; transition: all .15s; border:none; background:none;
}
.topnav-tab:hover { color:var(--text); }
.topnav-tab.active { color:var(--accent); background:var(--surface); box-shadow:var(--shadow); }
.topnav-spacer { flex:1; }
.topnav-actions { display:flex; gap:8px; align-items:center; }
.btn {
  padding: 7px 14px; border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 500; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text-dim); transition: all .15s;
  display:inline-flex; align-items:center; gap:6px;
}
.btn:hover { color:var(--text); border-color:var(--text-muted); background:var(--surface2); }
.btn input[type="file"] { display:none; }
.btn-accent { background:var(--accent); color:white; border-color:var(--accent); }
.btn-accent:hover { background:#1d4ed8; border-color:#1d4ed8; }
.btn-sm { padding:5px 10px; font-size:11px; }

/* PROJECT HEADER */
.project-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between;
  background: var(--surface);
}
.project-info { display:flex; flex-direction:column; gap:2px; }
.project-name {
  background:none; border:none; color:var(--text); font-size:18px;
  font-weight:700; font-family:inherit; outline:none; width:400px;
}
.project-name::placeholder { color:var(--text-muted); }
.project-sub {
  background:none; border:none; color:var(--text-dim); font-size:13px;
  font-family:inherit; outline:none; width:400px;
}
.project-sub::placeholder { color:var(--text-muted); }
.project-badges { display:flex; gap:8px; }
.badge {
  padding: 4px 10px; border-radius:20px; font-size:11px; font-weight:600;
  text-transform:uppercase; letter-spacing:.5px;
}
.badge-ftth { background:var(--green-bg); color:var(--green); }
.badge-backbone { background:var(--blue-bg); color:var(--blue); }
.source-count {
  padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600;
  background:var(--purple-bg); color:var(--purple);
}

/* ONBOARDING */
.onboard-overlay {
  position:fixed; inset:0; background:rgba(240,242,245,0.97);
  display:flex; align-items:center; justify-content:center; z-index:1000;
  backdrop-filter: blur(8px);
}
.onboard-overlay.hidden { display:none; }
.onboard-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; padding:48px; text-align:center;
  max-width:640px; width:90%; box-shadow: var(--shadow-md);
}
.onboard-card h2 { font-size:24px; font-weight:700; margin-bottom:4px; color:var(--text); }
.onboard-card .subtitle { color:var(--text-dim); font-size:14px; margin-bottom:28px; }
.dropzone {
  border:2px dashed var(--border); border-radius:var(--radius);
  padding:40px; cursor:pointer; transition:all .2s;
  background:var(--surface2); margin-bottom:20px;
}
.dropzone:hover, .dropzone.drag-over {
  border-color:var(--accent); background:var(--accent-bg);
}
.dropzone-icon { font-size:36px; margin-bottom:8px; opacity:.5; }
.dropzone-text { font-size:14px; font-weight:600; color:var(--text); }
.dropzone-sub { font-size:12px; color:var(--text-muted); margin-top:4px; }

/* File Queue */
.file-queue { margin-top:20px; text-align:left; }
.file-queue-title {
  font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:.5px;
  color:var(--text-muted); margin-bottom:8px;
}
.file-queue-list { display:flex; flex-direction:column; gap:6px; }
.file-queue-item {
  display:flex; align-items:center; gap:10px; padding:8px 12px;
  background:var(--surface2); border:1px solid var(--border-light);
  border-radius:var(--radius-sm); font-size:13px;
}
.file-queue-item .fq-icon { font-size:16px; flex-shrink:0; }
.file-queue-item .fq-name { flex:1; font-weight:500; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.file-queue-item .fq-type { font-size:10px; font-weight:600; text-transform:uppercase; padding:2px 6px; border-radius:4px; background:var(--accent-bg); color:var(--accent); }
.file-queue-item .fq-remove {
  cursor:pointer; color:var(--text-muted); font-size:16px; border:none; background:none; padding:0 4px;
  transition:color .15s;
}
.file-queue-item .fq-remove:hover { color:var(--red); }

.onboard-formats {
  display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
  margin-bottom:20px;
}
.analyze-btn {
  margin-top:16px; padding:12px 32px; border-radius:var(--radius-sm);
  font-size:14px; font-weight:600; cursor:pointer;
  border:none; background:var(--accent); color:white;
  transition: all .15s; width:100%;
}
.analyze-btn:hover { background:#1d4ed8; }
.analyze-btn:disabled { background:var(--text-muted); cursor:not-allowed; }

.skip-btn {
  margin-top:12px; padding:10px 24px; border-radius:var(--radius-sm);
  font-size:13px; font-weight:500; cursor:pointer;
  border:1px solid var(--border); background:var(--surface);
  color:var(--text-dim); transition: all .15s; width:100%;
}
.skip-btn:hover { color:var(--text); border-color:var(--text-muted); background:var(--surface2); }

/* STATUS */
.status-toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
  background:var(--surface); border:1px solid var(--border);
  padding:10px 20px; border-radius:var(--radius); font-size:13px;
  box-shadow:var(--shadow-md); z-index:200; display:none;
  transition: all .3s;
}
.status-toast.visible { display:block; }
.status-toast.error { border-color:var(--red); color:var(--red); }
.status-toast.success { border-color:var(--green); color:var(--green); }

/* LAYOUT */
.view { display:none; height:calc(100vh - 56px - 55px); }
.view.active { display:flex; }

/* MAP VIEW */
.map-sidebar {
  width:280px; min-width:280px; background:var(--surface);
  border-right:1px solid var(--border); overflow-y:auto;
  padding:16px; font-size:13px;
}
.map-sidebar h4 {
  font-size:10px; font-weight:700; text-transform:uppercase;
  letter-spacing:1px; color:var(--text-muted); margin:16px 0 8px;
}
.map-sidebar h4:first-child { margin-top:0; }
.stat { display:flex; justify-content:space-between; padding:3px 0; }
.stat .val { font-weight:600; color:var(--text); font-variant-numeric:tabular-nums; }
.sep { border-top:1px solid var(--border-light); margin:12px 0; }
.chk { display:flex; align-items:center; gap:8px; padding:3px 0; }
.chk input { accent-color:var(--accent); }
.chk label { cursor:pointer; flex:1; color:var(--text-dim); font-size:12px; }
.chk .ft { margin-left:auto; font-size:10px; color:var(--text-muted); font-variant-numeric:tabular-nums; }
.legend-row { display:flex; align-items:center; gap:8px; padding:2px 0; font-size:12px; color:var(--text-dim); }
.legend-dot { width:12px; height:12px; border-radius:3px; flex-shrink:0; }
.map-wrap { flex:1; position:relative; }
#map { width:100%; height:100%; }
select.sidebar-select {
  width:100%; padding:5px 8px; background:var(--surface2); color:var(--text);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  font-size:12px; margin-top:4px;
}

/* Map layer control */
.map-layer-ctrl {
  position:absolute; top:12px; right:12px; z-index:400;
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-sm);
  padding:8px; box-shadow:var(--shadow); display:flex; gap:4px;
}
.layer-btn {
  padding:5px 10px; border-radius:6px; font-size:11px; font-weight:500;
  cursor:pointer; border:1px solid var(--border); background:var(--surface2); color:var(--text-dim);
  transition:all .15s;
}
.layer-btn.active { background:var(--accent); color:white; border-color:var(--accent); }
.layer-btn:hover:not(.active) { background:var(--surface2); color:var(--text); }

/* DASHBOARD VIEW */
.dash { flex:1; overflow-y:auto; padding:24px; }
.dash-section { margin-bottom:28px; }
.dash-section-title {
  font-size:14px; font-weight:600; color:var(--text);
  margin-bottom:14px; display:flex; align-items:center; gap:10px;
}
.dash-section-title .line { flex:1; height:1px; background:var(--border); }

.cost-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
.card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px;
  box-shadow:var(--shadow);
}
.card-title {
  font-size:10px; font-weight:700; text-transform:uppercase;
  letter-spacing:.8px; color:var(--text-muted); margin-bottom:12px;
}
.card-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:4px 0; font-size:13px;
}
.card-row .lbl { color:var(--text-dim); }
.card-row .val { font-weight:600; font-variant-numeric:tabular-nums; color:var(--text); }
.card-row .cst { color:var(--accent); font-weight:600; font-size:12px; font-variant-numeric:tabular-nums; }

/* Editable qty */
.editable-qty {
  width:90px; padding:3px 6px; background:var(--surface2); color:var(--text);
  border:1px solid transparent; border-radius:4px; text-align:right;
  font-size:13px; font-family:inherit; font-weight:600; font-variant-numeric:tabular-nums;
  transition:border-color .15s;
}
.editable-qty:hover { border-color:var(--border); }
.editable-qty:focus { border-color:var(--accent); outline:none; background:white; box-shadow:0 0 0 2px var(--accent-bg); }

.total-budget-bar {
  background: linear-gradient(135deg, #1e293b, #334155);
  border:1px solid var(--border);
  border-radius:var(--radius); padding:18px 24px;
  display:flex; justify-content:space-between; align-items:center;
  color:white;
}
.total-budget-bar .budget-label { font-size:14px; }
.total-budget-bar .budget-amount { font-size:26px; font-weight:700; }

/* CATALOG TABLE */
.cat-table {
  width:100%; border-collapse:collapse; font-size:13px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
  margin-bottom:4px;
}
.cat-table th {
  background:var(--surface2); font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted);
  padding:8px 12px; text-align:left; border-bottom:1px solid var(--border);
}
.cat-table td {
  padding:5px 12px; border-bottom:1px solid var(--border-light);
  font-variant-numeric:tabular-nums;
}
.cat-table tr:last-child td { border-bottom:none; }
.cat-table tr:hover td { background:var(--surface2); }
.cat-table tr.has-qty td { background:var(--accent-bg); }
.cat-table tr.has-qty:hover td { background:rgba(37,99,235,0.12); }
.cat-table .row-label { font-weight:500; color:var(--text); }
.cat-table .unit-col { text-align:center; color:var(--text-muted); font-size:11px; }
.cat-table .ext-col { text-align:right; font-weight:600; color:var(--accent); }
.cat-table tfoot td {
  background:var(--surface2); font-weight:700; border-top:2px solid var(--border);
}

.cat-header {
  cursor:pointer; user-select:none; display:flex; align-items:center; gap:10px;
}
.cat-header:hover { opacity:.8; }
.cat-toggle-icon { font-size:10px; transition:transform .2s; }
.cat-toggle-icon.collapsed { transform:rotate(-90deg); }

.filter-bar {
  display:flex; gap:12px; align-items:center; margin-bottom:20px;
  padding:10px 16px; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius-sm); box-shadow:var(--shadow);
}
.filter-bar label { font-size:12px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
.filter-bar input[type="checkbox"] { accent-color:var(--accent); }

/* COMPARISON VIEW */
.compare-table {
  width:100%; border-collapse:collapse; font-size:13px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
}
.compare-table th {
  background:var(--surface2); font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted);
  padding:10px 14px; text-align:left; border-bottom:1px solid var(--border);
}
.compare-table td {
  padding:8px 14px; border-bottom:1px solid var(--border-light);
  font-variant-numeric:tabular-nums;
}
.compare-table tr:last-child td { border-bottom:none; }
.compare-table tr:hover td { background:var(--surface2); }
.compare-table .row-label { font-weight:500; color:var(--text); }
.compare-table .src-val { text-align:right; font-weight:600; }
.compare-table .diff-val { text-align:right; font-weight:600; }
.diff-pos { color:var(--green); }
.diff-neg { color:var(--red); }
.diff-zero { color:var(--text-muted); }
.source-chip {
  display:inline-flex; align-items:center; gap:4px; padding:2px 8px;
  border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;
}

/* MODAL */
.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.3); z-index:500; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal-bg.open { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:28px; max-width:440px; width:90%; box-shadow:var(--shadow-md); }
.modal h3 { font-size:16px; margin-bottom:12px; }
.modal input[type="text"] {
  width:100%; padding:9px 12px; background:var(--surface2); color:var(--text);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  font-size:13px; margin-bottom:12px;
}
.modal-actions { display:flex; gap:8px; justify-content:flex-end; }

/* Scrollbar */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--text-muted); }

/* leaflet overrides */
.leaflet-control-zoom a {
  background:var(--surface)!important; color:var(--text)!important;
  border-color:var(--border)!important;
}
.leaflet-control-attribution {
  background:rgba(255,255,255,.85)!important; color:var(--text-muted)!important; font-size:10px!important;
}
.leaflet-control-attribution a { color:var(--text-dim)!important; }
.leaflet-popup-content-wrapper {
  background:var(--surface); color:var(--text); border:1px solid var(--border);
  border-radius:var(--radius-sm); box-shadow:var(--shadow-md);
}
.leaflet-popup-tip { background:var(--surface); }
.leaflet-popup-content { font-size:12px; font-family:'Inter',sans-serif; }
</style>
</head>
<body>

<!-- ONBOARDING -->
<div class="onboard-overlay" id="onboard">
  <div class="onboard-card">
    <h2>Fiber - FTTX Materials Analyzer</h2>
    <p class="subtitle">Upload data sources to analyze fiber materials, or start with the full catalog</p>
    <div class="dropzone" id="dropzone">
      <div class="dropzone-icon">&#8593;</div>
      <div class="dropzone-text">Drop files here or click to browse</div>
      <div class="dropzone-sub">KMZ, KML, CSV, Excel, Smartsheet, or PDF &mdash; add as many as you need</div>
      <input type="file" id="fileInput" accept=".kmz,.kml,.csv,.xlsx,.xls,.pdf" multiple style="display:none">
    </div>
    <div class="onboard-formats">
      <label class="btn">CSV<input type="file" accept=".csv" multiple onchange="queueFiles(this.files);this.value=''"></label>
      <label class="btn">Excel / Smartsheet<input type="file" accept=".xlsx,.xls" multiple onchange="queueFiles(this.files);this.value=''"></label>
      <label class="btn">PDF<input type="file" accept=".pdf" multiple onchange="queueFiles(this.files);this.value=''"></label>
      <button class="btn" onclick="openDropbox()">Dropbox</button>
    </div>
    <div class="file-queue" id="fileQueueSection" style="display:none">
      <div class="file-queue-title">Queued Files (<span id="queueCount">0</span>)</div>
      <div class="file-queue-list" id="fileQueueList"></div>
    </div>
    <button class="analyze-btn" id="analyzeBtn" disabled onclick="processQueue()">Add files to begin</button>
    <button class="skip-btn" onclick="skipToEmptyCatalog()">Skip &mdash; start with empty materials catalog</button>
    <div style="margin-top:16px;color:var(--text-muted);font-size:12px;">150+ FTTX materials pre-loaded &mdash; upload files to auto-populate quantities or edit manually</div>
  </div>
</div>

<!-- DROPBOX MODAL -->
<div class="modal-bg" id="dbxModal">
  <div class="modal">
    <h3>Load from Dropbox</h3>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:12px;">Paste a Dropbox shared link:</p>
    <input type="text" id="dbxUrl" placeholder="https://www.dropbox.com/s/...">
    <div class="modal-actions">
      <button class="btn" onclick="document.getElementById('dbxModal').classList.remove('open')">Cancel</button>
      <button class="btn btn-accent" onclick="loadDropbox()">Load</button>
    </div>
  </div>
</div>

<!-- TOP NAV -->
<nav class="topnav">
  <div class="topnav-brand"><div class="icon">F</div>Fiber - FTTX Materials Analyzer</div>
  <div class="topnav-tabs">
    <button class="topnav-tab active" onclick="switchView('map')">Map</button>
    <button class="topnav-tab" onclick="switchView('dash')">Dashboard</button>
    <button class="topnav-tab" onclick="switchView('compare')">Compare Sources</button>
  </div>
  <div class="topnav-spacer"></div>
  <div class="topnav-actions">
    <label class="btn">+ Files<input type="file" accept=".kmz,.kml,.csv,.xlsx,.xls,.pdf" multiple onchange="addMoreFiles(this.files);this.value=''"></label>
    <button class="btn" onclick="openDropbox()">Dropbox</button>
    <button class="btn" onclick="doExport()">Export</button>
  </div>
</nav>

<!-- PROJECT HEADER -->
<div class="project-header">
  <div class="project-info">
    <input class="project-name" id="projName" value="Fiber - FTTX Materials Analyzer" placeholder="Project Name">
    <input class="project-sub" id="projSub" value="" placeholder="Subtitle / Company / Region">
  </div>
  <div class="project-badges">
    <span class="badge badge-ftth" id="badgeFTTH" style="display:none">FTTH</span>
    <span class="badge badge-backbone" id="badgeBackbone" style="display:none">Backbone</span>
    <span class="source-count" id="sourceCount" style="display:none">0 Sources</span>
  </div>
</div>

<!-- MAP VIEW -->
<div class="view active" id="viewMap">
  <div class="map-sidebar" id="sidebar">
    <h4>Overview</h4>
    <div class="stat"><span>Routes</span><span class="val" id="sRoutes">0</span></div>
    <div class="stat"><span>Length</span><span class="val" id="sLength">0 mi</span></div>
    <div class="stat"><span>Structures</span><span class="val" id="sHH">0</span></div>
    <div class="stat"><span>Visible</span><span class="val" id="sVisible">0</span></div>
    <div class="stat"><span>Type</span><span class="val" id="sType">--</span></div>
    <div class="stat"><span>Sources</span><span class="val" id="sSources">0</span></div>
    <div class="sep"></div>
    <h4>Materials Summary</h4>
    <div id="matsSummary"></div>
    <div class="sep"></div>
    <h4>Filter &mdash; Fiber / Cable</h4>
    <div id="filterFiber"></div>
    <div class="sep"></div>
    <h4>Filter &mdash; Conduit</h4>
    <div id="filterDuct"></div>
    <div class="sep"></div>
    <h4>Options</h4>
    <div class="chk"><input type="checkbox" id="chkHH" onchange="toggleHH()"><label for="chkHH">Show structures</label></div>
    <div class="chk"><input type="checkbox" id="chkSlack" checked onchange="recalcSidebar()"><label for="chkSlack">Include slack</label></div>
    <div style="margin-top:4px">
      <select class="sidebar-select" id="selSlack" onchange="recalcSidebar()">
        <option value="50">50 ft slack/handhole</option>
        <option value="100" selected>100 ft slack/handhole</option>
        <option value="150">150 ft slack/handhole</option>
      </select>
    </div>
    <div class="chk" style="margin-top:8px"><input type="checkbox" id="chkWaste" checked onchange="recalcSidebar()"><label for="chkWaste">Include waste buffer</label></div>
    <div>
      <select class="sidebar-select" id="selWaste" onchange="recalcSidebar()">
        <option value="0.03">3% waste</option>
        <option value="0.05" selected>5% waste</option>
        <option value="0.10">10% waste</option>
        <option value="0.15">15% waste</option>
      </select>
    </div>
    <div class="sep"></div>
    <h4>Legend</h4>
    <div id="legend"></div>
  </div>
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-layer-ctrl" id="mapLayers">
      <button class="layer-btn" onclick="setTile('street')" data-layer="street">Street</button>
      <button class="layer-btn active" onclick="setTile('terrain')" data-layer="terrain">Terrain</button>
      <button class="layer-btn" onclick="setTile('satellite')" data-layer="satellite">Satellite</button>
      <button class="layer-btn" onclick="setTile('topo')" data-layer="topo">Topo</button>
    </div>
  </div>
</div>

<!-- DASHBOARD VIEW -->
<div class="view" id="viewDash">
  <div class="dash">
    <div id="dashFilterBar"></div>
    <div id="materialsCatalog"></div>
    <div id="budgetSummary"></div>
  </div>
</div>

<!-- COMPARE VIEW -->
<div class="view" id="viewCompare">
  <div class="dash">
    <div class="dash-section">
      <div class="dash-section-title">Data Source Comparison<span class="line"></span></div>
      <div id="compareContent">
        <p style="color:var(--text-muted);font-size:14px;">Upload multiple files to see a comparison of materials across your data sources.</p>
      </div>
    </div>
  </div>
</div>

<!-- STATUS TOAST -->
<div class="status-toast" id="toast"></div>

<script>
// =========== STATE ===========
let routes = { type:'FeatureCollection', features:[] };
let structures = { type:'FeatureCollection', features:[] };
let quarterly = [];
let pType = 'ftth';
let map, routeLayerGroup, structureLayer, currentTileLayer;
let fileQueue = [];
let dataSources = [];
let hideZeros = true;
let collapsedCats = {};
const PALETTE = ['#e74c3c','#2563eb','#059669','#d97706','#7c3aed','#0d9488','#e67e22','#3498db','#e91e63','#00bcd4'];
const FIBER_COLORS = {2:'#059669',4:'#059669',6:'#0d9488',12:'#d97706',24:'#2563eb',48:'#7c3aed',72:'#dc2626',96:'#e67e22',144:'#e91e63',288:'#3498db',432:'#9b59b6',576:'#e74c3c',864:'#00bcd4'};

const TILES = {
  terrain:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',attr:'Esri, HERE, Garmin, OSM contributors'},
  street:{url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',attr:'&copy; OpenStreetMap contributors'},
  satellite:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',attr:'Esri, Maxar, Earthstar Geographics'},
  topo:{url:'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',attr:'&copy; OpenStreetMap, SRTM | &copy; OpenTopoMap'}
};

// =========== DEFAULT MATERIALS CATALOG ===========
const DEFAULT_MATERIALS = {
  fiber_cable: {
    label:'Fiber Cable', color:'var(--blue)', items:[
      {id:'micro_2f_aerial',name:'Micro Fiber 2F (Aerial)',unit:'ft',defaultCost:0.15,qty:0},
      {id:'micro_4f_aerial',name:'Micro Fiber 4F (Aerial)',unit:'ft',defaultCost:0.18,qty:0},
      {id:'micro_6f_aerial',name:'Micro Fiber 6F (Aerial)',unit:'ft',defaultCost:0.20,qty:0},
      {id:'micro_8f_aerial',name:'Micro Fiber 8F (Aerial)',unit:'ft',defaultCost:0.22,qty:0},
      {id:'micro_12f_aerial',name:'Micro Fiber 12F (Aerial)',unit:'ft',defaultCost:0.25,qty:0},
      {id:'micro_24f_aerial',name:'Micro Fiber 24F (Aerial)',unit:'ft',defaultCost:0.35,qty:0},
      {id:'micro_48f_aerial',name:'Micro Fiber 48F (Aerial)',unit:'ft',defaultCost:0.55,qty:0},
      {id:'micro_72f_aerial',name:'Micro Fiber 72F (Aerial)',unit:'ft',defaultCost:0.75,qty:0},
      {id:'micro_96f_aerial',name:'Micro Fiber 96F (Aerial)',unit:'ft',defaultCost:0.95,qty:0},
      {id:'micro_144f_aerial',name:'Micro Fiber 144F (Aerial)',unit:'ft',defaultCost:1.25,qty:0},
      {id:'micro_192f_aerial',name:'Micro Fiber 192F (Aerial)',unit:'ft',defaultCost:1.55,qty:0},
      {id:'micro_216f_aerial',name:'Micro Fiber 216F (Aerial)',unit:'ft',defaultCost:1.70,qty:0},
      {id:'micro_288f_aerial',name:'Micro Fiber 288F (Aerial)',unit:'ft',defaultCost:2.10,qty:0},
      {id:'micro_432f_aerial',name:'Micro Fiber 432F (Aerial)',unit:'ft',defaultCost:3.00,qty:0},
      {id:'micro_576f_aerial',name:'Micro Fiber 576F (Aerial)',unit:'ft',defaultCost:3.75,qty:0},
      {id:'micro_864f_aerial',name:'Micro Fiber 864F (Aerial)',unit:'ft',defaultCost:5.25,qty:0},
      {id:'micro_2f_ug',name:'Micro Fiber 2F (Underground)',unit:'ft',defaultCost:0.20,qty:0},
      {id:'micro_4f_ug',name:'Micro Fiber 4F (Underground)',unit:'ft',defaultCost:0.24,qty:0},
      {id:'micro_6f_ug',name:'Micro Fiber 6F (Underground)',unit:'ft',defaultCost:0.26,qty:0},
      {id:'micro_8f_ug',name:'Micro Fiber 8F (Underground)',unit:'ft',defaultCost:0.28,qty:0},
      {id:'micro_12f_ug',name:'Micro Fiber 12F (Underground)',unit:'ft',defaultCost:0.32,qty:0},
      {id:'micro_24f_ug',name:'Micro Fiber 24F (Underground)',unit:'ft',defaultCost:0.45,qty:0},
      {id:'micro_48f_ug',name:'Micro Fiber 48F (Underground)',unit:'ft',defaultCost:0.70,qty:0},
      {id:'micro_72f_ug',name:'Micro Fiber 72F (Underground)',unit:'ft',defaultCost:0.95,qty:0},
      {id:'micro_96f_ug',name:'Micro Fiber 96F (Underground)',unit:'ft',defaultCost:1.20,qty:0},
      {id:'micro_144f_ug',name:'Micro Fiber 144F (Underground)',unit:'ft',defaultCost:1.55,qty:0},
      {id:'micro_192f_ug',name:'Micro Fiber 192F (Underground)',unit:'ft',defaultCost:1.85,qty:0},
      {id:'micro_216f_ug',name:'Micro Fiber 216F (Underground)',unit:'ft',defaultCost:2.00,qty:0},
      {id:'micro_288f_ug',name:'Micro Fiber 288F (Underground)',unit:'ft',defaultCost:2.50,qty:0},
      {id:'micro_432f_ug',name:'Micro Fiber 432F (Underground)',unit:'ft',defaultCost:3.50,qty:0},
      {id:'micro_576f_ug',name:'Micro Fiber 576F (Underground)',unit:'ft',defaultCost:4.25,qty:0},
      {id:'micro_864f_ug',name:'Micro Fiber 864F (Underground)',unit:'ft',defaultCost:5.75,qty:0},
      {id:'drop_flat',name:'Drop Cable - Flat',unit:'ft',defaultCost:0.12,qty:0},
      {id:'drop_round',name:'Drop Cable - Round',unit:'ft',defaultCost:0.14,qty:0},
      {id:'drop_toneable',name:'Drop Cable - Toneable',unit:'ft',defaultCost:0.18,qty:0},
      {id:'drop_armored',name:'Drop Cable - Armored',unit:'ft',defaultCost:0.25,qty:0},
    ]
  },
  conduit_microduct: {
    label:'Conduit / Microduct', color:'var(--orange)', items:[
      {id:'microduct_5mm',name:'Microduct 5mm',unit:'ft',defaultCost:0.15,qty:0},
      {id:'microduct_7mm',name:'Microduct 7mm',unit:'ft',defaultCost:0.18,qty:0},
      {id:'microduct_10mm',name:'Microduct 10mm',unit:'ft',defaultCost:0.22,qty:0},
      {id:'microduct_12mm',name:'Microduct 12mm',unit:'ft',defaultCost:0.25,qty:0},
      {id:'microduct_14mm',name:'Microduct 14mm',unit:'ft',defaultCost:0.28,qty:0},
      {id:'microduct_16mm',name:'Microduct 16mm',unit:'ft',defaultCost:0.32,qty:0},
      {id:'microduct_18mm',name:'Microduct 18mm',unit:'ft',defaultCost:0.36,qty:0},
      {id:'multiway_1way',name:'Multi-way Microduct 1-way',unit:'ft',defaultCost:0.30,qty:0},
      {id:'multiway_2way',name:'Multi-way Microduct 2-way',unit:'ft',defaultCost:0.55,qty:0},
      {id:'multiway_3way',name:'Multi-way Microduct 3-way',unit:'ft',defaultCost:0.75,qty:0},
      {id:'multiway_4way',name:'Multi-way Microduct 4-way',unit:'ft',defaultCost:0.95,qty:0},
      {id:'multiway_7way',name:'Multi-way Microduct 7-way',unit:'ft',defaultCost:1.50,qty:0},
      {id:'multiway_12way',name:'Multi-way Microduct 12-way',unit:'ft',defaultCost:2.25,qty:0},
      {id:'multiway_19way',name:'Multi-way Microduct 19-way',unit:'ft',defaultCost:3.50,qty:0},
      {id:'multiway_24way',name:'Multi-way Microduct 24-way',unit:'ft',defaultCost:4.25,qty:0},
      {id:'hdpe_1in',name:'HDPE Conduit 1"',unit:'ft',defaultCost:0.45,qty:0},
      {id:'hdpe_1_25in',name:'HDPE Conduit 1.25"',unit:'ft',defaultCost:0.55,qty:0},
      {id:'hdpe_1_5in',name:'HDPE Conduit 1.5"',unit:'ft',defaultCost:0.65,qty:0},
      {id:'hdpe_2in',name:'HDPE Conduit 2"',unit:'ft',defaultCost:0.85,qty:0},
      {id:'hdpe_3in',name:'HDPE Conduit 3"',unit:'ft',defaultCost:1.40,qty:0},
      {id:'hdpe_4in',name:'HDPE Conduit 4"',unit:'ft',defaultCost:1.95,qty:0},
      {id:'innerduct_1in',name:'Innerduct 1"',unit:'ft',defaultCost:0.35,qty:0},
      {id:'innerduct_1_25in',name:'Innerduct 1.25"',unit:'ft',defaultCost:0.42,qty:0},
      {id:'flex_conduit',name:'Flexible Conduit',unit:'ft',defaultCost:0.60,qty:0},
    ]
  },
  structures_enclosures: {
    label:'Structures / Enclosures', color:'var(--green)', items:[
      {id:'hh_11x18',name:'Handhole 11x18 (Tier 1)',unit:'ea',defaultCost:350,qty:0},
      {id:'hh_17x30',name:'Handhole 17x30 (Tier 2)',unit:'ea',defaultCost:550,qty:0},
      {id:'hh_24x36',name:'Handhole 24x36 (Tier 3)',unit:'ea',defaultCost:850,qty:0},
      {id:'hh_30x48',name:'Handhole 30x48 (Tier 4)',unit:'ea',defaultCost:1200,qty:0},
      {id:'hh_36x60',name:'Handhole 36x60 (Tier 5)',unit:'ea',defaultCost:1800,qty:0},
      {id:'hh_48x72',name:'Handhole 48x72 (Tier 6)',unit:'ea',defaultCost:2500,qty:0},
      {id:'vault_small',name:'Vault - Small',unit:'ea',defaultCost:3500,qty:0},
      {id:'vault_medium',name:'Vault - Medium',unit:'ea',defaultCost:5500,qty:0},
      {id:'vault_large',name:'Vault - Large',unit:'ea',defaultCost:8500,qty:0},
      {id:'pedestal_sm',name:'Pedestal - Small',unit:'ea',defaultCost:250,qty:0},
      {id:'pedestal_lg',name:'Pedestal - Large',unit:'ea',defaultCost:450,qty:0},
      {id:'fdh_72',name:'FDH Cabinet 72-port',unit:'ea',defaultCost:2500,qty:0},
      {id:'fdh_144',name:'FDH Cabinet 144-port',unit:'ea',defaultCost:3500,qty:0},
      {id:'fdh_288',name:'FDH Cabinet 288-port',unit:'ea',defaultCost:5000,qty:0},
      {id:'fdh_432',name:'FDH Cabinet 432-port',unit:'ea',defaultCost:7000,qty:0},
      {id:'fdh_576',name:'FDH Cabinet 576-port',unit:'ea',defaultCost:9000,qty:0},
      {id:'splice_enc_aerial',name:'Splice Enclosure - Aerial',unit:'ea',defaultCost:180,qty:0},
      {id:'splice_enc_ug',name:'Splice Enclosure - Underground',unit:'ea',defaultCost:220,qty:0},
      {id:'splice_enc_inline',name:'Splice Enclosure - In-line',unit:'ea',defaultCost:160,qty:0},
      {id:'ont_enclosure',name:'ONT Enclosure',unit:'ea',defaultCost:85,qty:0},
      {id:'olt_cabinet',name:'OLT Cabinet',unit:'ea',defaultCost:15000,qty:0},
      {id:'aerial_closure',name:'Aerial Closure',unit:'ea',defaultCost:175,qty:0},
      {id:'pole_mount_enc',name:'Pole-mount Enclosure',unit:'ea',defaultCost:200,qty:0},
    ]
  },
  splice_components: {
    label:'Splice Components', color:'var(--purple)', items:[
      {id:'splice_closure_dome',name:'Splice Closure - Dome',unit:'ea',defaultCost:175,qty:0},
      {id:'splice_closure_inline',name:'Splice Closure - In-line',unit:'ea',defaultCost:150,qty:0},
      {id:'splice_closure_flat',name:'Splice Closure - Flat',unit:'ea',defaultCost:130,qty:0},
      {id:'splice_tray_12f',name:'Splice Tray 12F',unit:'ea',defaultCost:12,qty:0},
      {id:'splice_tray_24f',name:'Splice Tray 24F',unit:'ea',defaultCost:18,qty:0},
      {id:'mechanical_splice',name:'Mechanical Splice',unit:'ea',defaultCost:8,qty:0},
      {id:'fusion_splice',name:'Fusion Splice',unit:'per splice',defaultCost:25,qty:0},
      {id:'splice_organizer',name:'Splice Organizer Tray',unit:'ea',defaultCost:15,qty:0},
      {id:'heat_shrink',name:'Heat Shrink Protector',unit:'ea',defaultCost:2,qty:0},
    ]
  },
  connectors_terminals: {
    label:'Connectors / Terminals', color:'var(--teal)', items:[
      {id:'conn_sc_apc',name:'SC/APC Connector',unit:'ea',defaultCost:4.50,qty:0},
      {id:'conn_sc_upc',name:'SC/UPC Connector',unit:'ea',defaultCost:3.75,qty:0},
      {id:'conn_lc_apc',name:'LC/APC Connector',unit:'ea',defaultCost:5.00,qty:0},
      {id:'conn_lc_upc',name:'LC/UPC Connector',unit:'ea',defaultCost:4.25,qty:0},
      {id:'conn_mpo_mtp',name:'MPO/MTP Connector',unit:'ea',defaultCost:35.00,qty:0},
      {id:'preconn_drop',name:'Pre-connectorized Drop',unit:'ea',defaultCost:12.00,qty:0},
      {id:'drop_term_2',name:'Drop Terminal 2-port',unit:'ea',defaultCost:45,qty:0},
      {id:'drop_term_4',name:'Drop Terminal 4-port',unit:'ea',defaultCost:65,qty:0},
      {id:'drop_term_8',name:'Drop Terminal 8-port',unit:'ea',defaultCost:95,qty:0},
      {id:'drop_term_12',name:'Drop Terminal 12-port',unit:'ea',defaultCost:125,qty:0},
      {id:'drop_term_16',name:'Drop Terminal 16-port',unit:'ea',defaultCost:155,qty:0},
      {id:'mst_4',name:'MST 4-port',unit:'ea',defaultCost:85,qty:0},
      {id:'mst_8',name:'MST 8-port',unit:'ea',defaultCost:135,qty:0},
      {id:'mst_12',name:'MST 12-port',unit:'ea',defaultCost:185,qty:0},
      {id:'mst_16',name:'MST 16-port',unit:'ea',defaultCost:235,qty:0},
      {id:'nap',name:'Network Access Point (NAP)',unit:'ea',defaultCost:120,qty:0},
      {id:'fdt',name:'Fiber Distribution Terminal',unit:'ea',defaultCost:200,qty:0},
    ]
  },
  drop_materials: {
    label:'Drop Materials (Last Mile)', color:'var(--accent)', items:[
      {id:'drop_100ft',name:'Drop Cable 100ft',unit:'ea',defaultCost:15,qty:0},
      {id:'drop_150ft',name:'Drop Cable 150ft',unit:'ea',defaultCost:22,qty:0},
      {id:'drop_200ft',name:'Drop Cable 200ft',unit:'ea',defaultCost:28,qty:0},
      {id:'drop_250ft',name:'Drop Cable 250ft',unit:'ea',defaultCost:35,qty:0},
      {id:'drop_300ft',name:'Drop Cable 300ft',unit:'ea',defaultCost:42,qty:0},
      {id:'drop_500ft',name:'Drop Cable 500ft',unit:'ea',defaultCost:65,qty:0},
      {id:'nid',name:'NID (Network Interface Device)',unit:'ea',defaultCost:45,qty:0},
      {id:'slack_loop',name:'Slack Loop',unit:'ea',defaultCost:3,qty:0},
      {id:'p_hook',name:'P-hook / Cable Clip',unit:'ea',defaultCost:0.50,qty:0},
      {id:'weather_head',name:'Weather Head',unit:'ea',defaultCost:12,qty:0},
      {id:'ont_unit',name:'ONT Unit',unit:'ea',defaultCost:150,qty:0},
    ]
  },
  aerial_pole: {
    label:'Aerial / Pole Hardware', color:'var(--red)', items:[
      {id:'strand_6m',name:'Strand 6M Messenger Wire',unit:'ft',defaultCost:0.10,qty:0},
      {id:'strand_10m',name:'Strand 10M Messenger Wire',unit:'ft',defaultCost:0.14,qty:0},
      {id:'strand_25m',name:'Strand 25M Messenger Wire',unit:'ft',defaultCost:0.22,qty:0},
      {id:'lashing_wire',name:'Lashing Wire',unit:'ft',defaultCost:0.04,qty:0},
      {id:'j_hook',name:'J-hook',unit:'ea',defaultCost:2.50,qty:0},
      {id:'p_clamp',name:'P-clamp',unit:'ea',defaultCost:3.50,qty:0},
      {id:'dead_end_clamp',name:'Dead-end Clamp / Guy Grip',unit:'ea',defaultCost:18,qty:0},
      {id:'down_guy_anchor',name:'Down Guy and Anchor',unit:'ea',defaultCost:250,qty:0},
      {id:'pole_bracket',name:'Pole Attachment / Bracket',unit:'ea',defaultCost:25,qty:0},
      {id:'aerial_splice_closure',name:'Aerial Splice Closure',unit:'ea',defaultCost:185,qty:0},
      {id:'snow_shoe',name:'Snow Shoe / Cable Spacer',unit:'ea',defaultCost:8,qty:0},
    ]
  },
  underground_boring: {
    label:'Underground / Boring', color:'var(--orange)', items:[
      {id:'bore_ft',name:'Directional Bore',unit:'ft',defaultCost:8.50,qty:0},
      {id:'plow_ft',name:'Plow',unit:'ft',defaultCost:3.50,qty:0},
      {id:'trench_ft',name:'Trench',unit:'ft',defaultCost:5.00,qty:0},
      {id:'open_trench_ft',name:'Open Trench with Restore',unit:'ft',defaultCost:12.00,qty:0},
      {id:'concrete_enc_ft',name:'Concrete Encasement',unit:'ft',defaultCost:18.00,qty:0},
      {id:'warning_tape',name:'Warning Tape',unit:'ft',defaultCost:0.03,qty:0},
      {id:'tracer_wire',name:'Locate Wire / Tracer Wire',unit:'ft',defaultCost:0.06,qty:0},
      {id:'pull_tape',name:'Pull Tape / Pull Rope',unit:'ft',defaultCost:0.02,qty:0},
    ]
  },
  testing_passive: {
    label:'Testing / Passive Equipment', color:'var(--teal)', items:[
      {id:'splitter_1x2',name:'Splitter 1x2',unit:'ea',defaultCost:8,qty:0},
      {id:'splitter_1x4',name:'Splitter 1x4',unit:'ea',defaultCost:12,qty:0},
      {id:'splitter_1x8',name:'Splitter 1x8',unit:'ea',defaultCost:18,qty:0},
      {id:'splitter_1x16',name:'Splitter 1x16',unit:'ea',defaultCost:28,qty:0},
      {id:'splitter_1x32',name:'Splitter 1x32',unit:'ea',defaultCost:45,qty:0},
      {id:'splitter_1x64',name:'Splitter 1x64',unit:'ea',defaultCost:85,qty:0},
      {id:'splitter_1x128',name:'Splitter 1x128',unit:'ea',defaultCost:150,qty:0},
      {id:'wdm_filter',name:'WDM Filter',unit:'ea',defaultCost:35,qty:0},
      {id:'patch_panel_12',name:'Patch Panel 12-port',unit:'ea',defaultCost:65,qty:0},
      {id:'patch_panel_24',name:'Patch Panel 24-port',unit:'ea',defaultCost:95,qty:0},
      {id:'patch_panel_48',name:'Patch Panel 48-port',unit:'ea',defaultCost:145,qty:0},
      {id:'patch_panel_72',name:'Patch Panel 72-port',unit:'ea',defaultCost:195,qty:0},
      {id:'patch_panel_96',name:'Patch Panel 96-port',unit:'ea',defaultCost:245,qty:0},
      {id:'fiber_patch_cord',name:'Fiber Patch Cord',unit:'ea',defaultCost:8,qty:0},
      {id:'attenuator',name:'Attenuator',unit:'ea',defaultCost:12,qty:0},
    ]
  },
  restoration_misc: {
    label:'Restoration / Misc', color:'var(--text-dim)', items:[
      {id:'ground_rod',name:'Ground Rod',unit:'ea',defaultCost:25,qty:0},
      {id:'grounding_hw',name:'Grounding Hardware',unit:'ea',defaultCost:15,qty:0},
      {id:'marker_post',name:'Marker Post / Bollard',unit:'ea',defaultCost:35,qty:0},
      {id:'warning_sign',name:'Warning Sign',unit:'ea',defaultCost:18,qty:0},
      {id:'permit_cost',name:'Permit Cost',unit:'ea',defaultCost:500,qty:0},
      {id:'easement_cost',name:'Easement Cost',unit:'ea',defaultCost:1500,qty:0},
    ]
  }
};

// Material aliases: map file-detected keys to catalog IDs
const MATERIAL_ALIASES = {
  '2F':'micro_2f_ug','4F':'micro_4f_ug','6F':'micro_6f_ug','8F':'micro_8f_ug',
  '12F':'micro_12f_ug','24F':'micro_24f_ug','48F':'micro_48f_ug','72F':'micro_72f_ug',
  '96F':'micro_96f_ug','144F':'micro_144f_ug','192F':'micro_192f_ug','216F':'micro_216f_ug',
  '288F':'micro_288f_ug','432F':'micro_432f_ug','576F':'micro_576f_ug','864F':'micro_864f_ug',
  '1-way duct':'multiway_1way','2-way duct':'multiway_2way','3-way duct':'multiway_3way',
  '4-way duct':'multiway_4way','7-way duct':'multiway_7way','12-way duct':'multiway_12way',
  'Handholes':'hh_17x30','Splice Closures':'splice_closure_dome',
};

function resolveToMaterialId(rawKey){
  if(MATERIAL_ALIASES[rawKey]!==undefined) return MATERIAL_ALIASES[rawKey];
  const n=rawKey.toLowerCase().trim();
  let m=n.match(/^(\d+)\s*(?:fibers?|f)\s*(?:\(ft\))?$/);
  if(m) return MATERIAL_ALIASES[m[1]+'F']||null;
  m=n.match(/^(\d+)\s*way\s*duct\s*(?:\(ft\))?$/);
  if(m) return MATERIAL_ALIASES[m[1]+'-way duct']||null;
  if(/microduct/.test(n)) return 'microduct_10mm';
  if(/innerduct/.test(n)) return 'innerduct_1in';
  if(/drop\s*cable/.test(n)) return 'drop_flat';
  if(/splice\s*closure/.test(n)) return 'splice_closure_dome';
  if(/handhole/.test(n)) return 'hh_17x30';
  return null;
}

// Runtime mutable copy
let projectMaterials = JSON.parse(JSON.stringify(DEFAULT_MATERIALS));

function mergeMaterialsIntoCatalog(){
  projectMaterials = JSON.parse(JSON.stringify(DEFAULT_MATERIALS));
  const unmapped = {};
  dataSources.forEach(src=>{
    Object.entries(src.materials).forEach(([rawKey,quantity])=>{
      if(rawKey==='Structures') return; // handled separately
      const catId = resolveToMaterialId(rawKey);
      if(catId){
        for(const cat of Object.values(projectMaterials)){
          const item=cat.items.find(it=>it.id===catId);
          if(item){ item.qty+=quantity; break; }
        }
      } else {
        unmapped[rawKey]=(unmapped[rawKey]||0)+quantity;
      }
    });
  });
  // Map structure counts to handholes
  const hhCount = structures.features.filter(f=>f.properties.type==='handhole').length;
  const cabCount = structures.features.filter(f=>f.properties.type==='cabinet').length;
  if(hhCount>0){
    const hhItem = projectMaterials.structures_enclosures.items.find(it=>it.id==='hh_17x30');
    if(hhItem) hhItem.qty += hhCount;
  }
  if(cabCount>0){
    const cabItem = projectMaterials.structures_enclosures.items.find(it=>it.id==='olt_cabinet');
    if(cabItem) cabItem.qty += cabCount;
  }
  if(Object.keys(unmapped).length>0){
    projectMaterials.unmapped={
      label:'Unmapped / Custom Materials', color:'var(--text-muted)',
      items: Object.entries(unmapped).map(([key,qty])=>({
        id:'unmapped_'+key.toLowerCase().replace(/[^a-z0-9]/g,'_'),
        name:key, unit:'ea', defaultCost:0, qty:qty
      }))
    };
  }
}

// =========== FILE QUEUE ===========
function queueFiles(files){
  for(const f of files){
    const ext=f.name.split('.').pop().toLowerCase();
    if(['kmz','kml','csv','xlsx','xls','pdf'].includes(ext)) fileQueue.push(f);
  }
  renderQueue();
}
function removeFromQueue(idx){ fileQueue.splice(idx,1); renderQueue(); }
function renderQueue(){
  const sec=document.getElementById('fileQueueSection');
  const list=document.getElementById('fileQueueList');
  const cnt=document.getElementById('queueCount');
  const btn=document.getElementById('analyzeBtn');
  if(fileQueue.length===0){ sec.style.display='none'; btn.disabled=true; btn.textContent='Add files to begin'; return; }
  sec.style.display='block'; cnt.textContent=fileQueue.length;
  btn.disabled=false; btn.textContent=`Analyze ${fileQueue.length} file${fileQueue.length>1?'s':''}`;
  const icons={kmz:'&#127758;',kml:'&#127758;',csv:'&#128196;',xlsx:'&#128202;',xls:'&#128202;',pdf:'&#128213;'};
  list.innerHTML=fileQueue.map((f,i)=>{
    const ext=f.name.split('.').pop().toLowerCase();
    return `<div class="file-queue-item"><span class="fq-icon">${icons[ext]||'&#128196;'}</span><span class="fq-name">${f.name}</span><span class="fq-type">${ext}</span><button class="fq-remove" onclick="removeFromQueue(${i})" title="Remove">&times;</button></div>`;
  }).join('');
}
async function processQueue(){
  const btn=document.getElementById('analyzeBtn');
  btn.disabled=true; btn.textContent='Processing...';
  for(const f of fileQueue) await processFile(f);
  fileQueue=[];
  mergeAllSources();
  render();
}
async function processFile(f){
  const ext=f.name.split('.').pop().toLowerCase();
  const source={name:f.name,type:ext,routes:[],structures:[],quarterly:[],materials:{}};
  try{
    if(ext==='kmz'||ext==='kml') await parseKMZToSource(f,source);
    else if(ext==='csv') await parseCSVToSource(f,source);
    else if(ext==='xlsx'||ext==='xls') await parseExcelToSource(f,source);
    else if(ext==='pdf') await parsePDFToSource(f,source);
    dataSources.push(source);
    toast(`Loaded: ${f.name}`,'success');
  }catch(e){ toast(`Error: ${f.name} - ${e.message}`,'error'); console.error(e); }
}
function addMoreFiles(files){
  for(const f of files) processFile(f).then(()=>{ mergeAllSources(); render(); });
}

// =========== KMZ PARSER ===========
async function parseKMZToSource(file,source){
  toast('Parsing '+file.name+'...');
  const ab=await file.arrayBuffer();
  let kml;
  if(file.name.endsWith('.kml')){ kml=new TextDecoder().decode(ab); }
  else{ const zip=await JSZip.loadAsync(ab); const kf=Object.keys(zip.files).find(n=>n.endsWith('.kml')); if(!kf)throw new Error('No KML in KMZ'); kml=await zip.files[kf].async('string'); }
  const feats=[],pts=[];
  const pms=allPlacemarks(kml);
  for(const pm of pms){
    const name=tag(pm,'name')||'Unknown';
    const coords=tag(pm,'coordinates');
    if(!coords)continue;
    const ext={};
    for(const m of pm.matchAll(/<SimpleData name="([^"]*)">(.*?)<\/SimpleData>/gs)) ext[m[1].toLowerCase()]=m[2].trim();
    if(pm.includes('<LineString>')){
      const cc=parseCoords(coords);if(cc.length<2)continue;
      const ft=haversine(cc);
      const p={name,route_type:'fiber',length_ft:Math.round(ft*100)/100,source:file.name};
      const fm=name.match(/MMT(\d+)/i)||name.match(/(\d+)\s*F(?:\b|-)/i)||name.match(/(\d+)\s*fiber/i);
      if(fm){let fc=parseInt(fm[1]);if(name.match(/MMT24\b/)&&fc===24)fc=432;p.fiber_count=fc;}
      const dm=name.match(/UGM(\d+)/i)||name.match(/(\d+)\s*way/i);
      if(dm){const u=parseInt(dm[1]);p.duct_ways={1:2,2:4,3:7}[u]||u;p.route_type='conduit';}
      feats.push({type:'Feature',properties:p,geometry:{type:'LineString',coordinates:cc}});
    }else if(pm.includes('<Point>')){
      const c=coords.trim().split(',');
      if(c.length>=2){
        const lon=parseFloat(c[0]),lat=parseFloat(c[1]);
        if(!isNaN(lon)&&!isNaN(lat)){
          const folder=folderOf(kml,pm);
          const isCab=/cabinet|olt/i.test(name)||/cabinet|olt/i.test(folder);
          pts.push({type:'Feature',properties:{name,type:isCab?'cabinet':'handhole',source:file.name},geometry:{type:'Point',coordinates:[lon,lat]}});
        }
      }
    }
  }
  // FTTH auto-classify
  const unclass=feats.filter(f=>!f.properties.fiber_count&&f.properties.route_type==='fiber');
  if(unclass.length>50){
    const sorted=[...unclass].sort((a,b)=>a.properties.length_ft-b.properties.length_ft);
    const n=sorted.length;
    const t1=sorted[Math.floor(n*.92)]?.properties.length_ft||656;
    const t2=sorted[Math.floor(n*.98)]?.properties.length_ft||1638;
    feats.forEach(f=>{
      if(f.properties.fiber_count||f.properties.route_type!=='fiber')return;
      const ft=f.properties.length_ft;
      if(ft<=t1){f.properties.fiber_count=2;f.properties.cable_type='Drop';}
      else if(ft<=t2){f.properties.fiber_count=24;f.properties.cable_type='Lateral/Feeder';}
      else{f.properties.fiber_count=72;f.properties.cable_type='Distribution';}
    });
  }
  source.routes=feats; source.structures=pts;
  const mats={};
  feats.forEach(f=>{
    if(f.properties.fiber_count){ const k=f.properties.fiber_count+'F'; mats[k]=(mats[k]||0)+(f.properties.length_ft||0); }
    if(f.properties.duct_ways){ const k=f.properties.duct_ways+'-way duct'; mats[k]=(mats[k]||0)+(f.properties.length_ft||0); }
  });
  mats['Structures']=pts.length;
  source.materials=mats;
}

// =========== CSV PARSER ===========
async function parseCSVToSource(file,source){
  const text=await file.text(); const lines=text.trim().split('\n');
  if(lines.length<2)throw new Error('Empty CSV');
  const hdr=lines[0].split(',').map(h=>h.trim()); const data=[];
  for(let i=1;i<lines.length;i++){
    const v=lines[i].split(',');if(!v[0]?.trim())continue;
    const row={};hdr.forEach((h,j)=>{row[h]=v[j]?v[j].trim():'0';});data.push(row);
  }
  source.quarterly=data;
  const mats={};
  data.forEach(row=>{Object.keys(row).forEach(k=>{if(k==='Quarter'||k==='Total Routes')return;const v=parseFloat(row[k])||0;if(v>0)mats[k]=(mats[k]||0)+v;});});
  source.materials=mats;
}

// =========== EXCEL PARSER ===========
async function parseExcelToSource(file,source){
  const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'});
  const allMats={};
  wb.SheetNames.forEach(sheetName=>{
    const data=XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
    if(data.length){
      if(data[0].Quarter) source.quarterly=data.map(r=>{const c={};Object.keys(r).forEach(k=>{c[k]=String(r[k]);});return c;});
      data.forEach(row=>{Object.keys(row).forEach(k=>{const v=parseFloat(row[k]);if(!isNaN(v)&&v>0&&k!=='Quarter') allMats[k]=(allMats[k]||0)+v;});});
    }
  });
  source.materials=allMats;
}

// =========== PDF PARSER ===========
async function parsePDFToSource(file,source){
  toast('Reading PDF...');
  pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
  let txt='';
  for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const tc=await p.getTextContent();txt+=tc.items.map(x=>x.str).join(' ')+'\n';}
  const mats={};
  const numMatches=txt.matchAll(/(\d[\d,]*\.?\d*)\s*(?:linear\s+)?(?:ft|feet|foot)\b/gi);
  for(const m of numMatches){
    const v=parseFloat(m[1].replace(/,/g,''));
    if(v>100){const ctx=txt.substring(Math.max(0,m.index-60),m.index+m[0].length+20).trim();mats['PDF: '+ctx.substring(0,40)]=v;}
  }
  const hhMatch=txt.match(/(\d[\d,]*)\s*handholes?/i);
  if(hhMatch) mats['Handholes']=parseInt(hhMatch[1].replace(/,/g,''));
  const spliceMatch=txt.match(/(\d[\d,]*)\s*splice/i);
  if(spliceMatch) mats['Splice Closures']=parseInt(spliceMatch[1].replace(/,/g,''));
  source.materials=mats; source.pdfText=txt;
}

// =========== MERGE SOURCES ===========
function mergeAllSources(){
  routes={type:'FeatureCollection',features:[]};
  structures={type:'FeatureCollection',features:[]};
  quarterly=[];
  dataSources.forEach(src=>{
    if(src.routes.length) routes.features.push(...src.routes);
    if(src.structures.length) structures.features.push(...src.structures);
    if(src.quarterly.length) quarterly.push(...src.quarterly);
  });
  if(!quarterly.length&&routes.features.length) autoQuarterly();
  detectType();
  updateSourceCount();
  mergeMaterialsIntoCatalog();
}

function updateSourceCount(){
  const el=document.getElementById('sourceCount');
  const sEl=document.getElementById('sSources');
  el.style.display=dataSources.length?'':'none';
  el.textContent=dataSources.length+' Source'+(dataSources.length!==1?'s':'');
  sEl.textContent=dataSources.length;
}

// =========== HELPERS ===========
function allPlacemarks(kml){const r=[];let i=0;while(true){const s=kml.indexOf('<Placemark',i);if(s===-1)break;const e=kml.indexOf('</Placemark>',s);if(e===-1)break;r.push(kml.substring(s,e+12));i=e+12;}return r;}
function tag(t,n){const m=t.match(new RegExp(`<${n}[^>]*>(.*?)</${n}>`,'s'));return m?m[1].replace('<![CDATA[','').replace(']]>','').trim():null;}
function parseCoords(t){return t.trim().split(/\s+/).map(c=>{const p=c.split(',');if(p.length>=2){const a=parseFloat(p[0]),b=parseFloat(p[1]);if(!isNaN(a)&&!isNaN(b))return[a,b];}return null}).filter(Boolean);}
function haversine(cc){const R=20925524.9;let t=0;for(let i=0;i<cc.length-1;i++){const[a,b]=cc[i],[c,d]=cc[i+1];const dl=(d-b)*Math.PI/180,dn=(c-a)*Math.PI/180;const x=Math.sin(dl/2)**2+Math.cos(b*Math.PI/180)*Math.cos(d*Math.PI/180)*Math.sin(dn/2)**2;t+=R*2*Math.asin(Math.sqrt(x));}return t;}
function folderOf(kml,pm){const i=kml.indexOf(pm);if(i===-1)return'';const before=kml.substring(Math.max(0,i-2000),i);const m=[...before.matchAll(/<name[^>]*>(.*?)<\/name>/gs)];return m.length?m[m.length-1][1]:'';}

function detectType(){
  const fcs=new Set();
  routes.features.forEach(f=>{if(f.properties.fiber_count)fcs.add(f.properties.fiber_count);});
  const small=[2,4,6,8,12,24].some(x=>fcs.has(x));
  const big=[288,432].some(x=>fcs.has(x));
  const hasCable=routes.features.some(f=>f.properties.cable_type);
  pType=(small&&!big)||hasCable?'ftth':'backbone';
  document.getElementById('sType').textContent=pType==='ftth'?'FTTH':'Backbone';
  document.getElementById('badgeFTTH').style.display=pType==='ftth'?'':'none';
  document.getElementById('badgeBackbone').style.display=pType==='backbone'?'':'none';
}

function autoQuarterly(){
  const byFc={},byDuct={},byCable={};let total=0;
  routes.features.forEach(f=>{
    total+=f.properties.length_ft||0;
    if(f.properties.route_type==='conduit'){const w=f.properties.duct_ways||7;byDuct[w]=(byDuct[w]||0)+(f.properties.length_ft||0);}
    if(f.properties.fiber_count){const fc=f.properties.fiber_count;byFc[fc]=(byFc[fc]||0)+(f.properties.length_ft||0);}
    if(f.properties.cable_type){const ct=f.properties.cable_type;byCable[ct]=(byCable[ct]||0)+(f.properties.length_ft||0);}
  });
  const row={'Quarter':'All Routes','Total Routes':routes.features.length.toString(),'Total Length (ft)':total.toFixed(2)};
  Object.keys(byFc).sort((a,b)=>a-b).forEach(fc=>{row[fc+' fibers (ft)']=byFc[fc].toFixed(2);});
  Object.keys(byDuct).sort((a,b)=>a-b).forEach(w=>{row[w+' way duct (ft)']=byDuct[w].toFixed(2);});
  Object.keys(byCable).forEach(ct=>{row[ct+' Cable (ft)']=byCable[ct].toFixed(2);});
  if(pType==='ftth'&&Object.keys(byDuct).length===0){
    row['Microduct (ft)']=(total*0.35*0.6).toFixed(2);
    row['Innerduct (ft)']=(total*0.35*0.4).toFixed(2);
  }
  quarterly=[row];
  routes.features.forEach(f=>{f.properties.quarter='All Routes';});
}

function getCols(){
  if(!quarterly.length)return{fibers:[],ducts:[],cables:[]};
  const fibers=[],ducts=[],cables=[];
  Object.keys(quarterly[0]).forEach(k=>{
    let m=k.match(/^(\d+)\s*fibers?\s*\(ft\)$/i);if(m){fibers.push({key:k,count:+m[1],label:m[1]+'F'});return;}
    m=k.match(/^(\d+)\s*way\s*duct\s*\(ft\)$/i);if(m){ducts.push({key:k,ways:+m[1],label:m[1]+'-way'});return;}
    m=k.match(/^(.+?)\s*cable\s*\(ft\)$/i);if(m){cables.push({key:k,name:m[1].trim(),label:m[1].trim()});return;}
    m=k.match(/^(microduct|innerduct)\s*\(ft\)$/i);if(m){ducts.push({key:k,ways:0,label:m[1]});return;}
  });
  fibers.sort((a,b)=>a.count-b.count);ducts.sort((a,b)=>a.ways-b.ways);
  return{fibers,ducts,cables};
}

// =========== UI HELPERS ===========
function toast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='status-toast visible '+(type||'');
  clearTimeout(t._t);t._t=setTimeout(()=>{t.className='status-toast';},4000);
}

function switchView(v){
  document.querySelectorAll('.topnav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(t=>t.classList.remove('active'));
  if(v==='map'){
    document.querySelector('.topnav-tab:nth-child(1)').classList.add('active');
    document.getElementById('viewMap').classList.add('active');
    if(map)map.invalidateSize();
  }else if(v==='dash'){
    document.querySelector('.topnav-tab:nth-child(2)').classList.add('active');
    document.getElementById('viewDash').classList.add('active');
    buildDash();
  }else{
    document.querySelector('.topnav-tab:nth-child(3)').classList.add('active');
    document.getElementById('viewCompare').classList.add('active');
    buildCompare();
  }
}

function fmt(n){return Math.round(n).toLocaleString();}
function fmtC(n){return n===0?'$0':'$'+n.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}
function fmtC2(n){return '$'+n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

function skipToEmptyCatalog(){
  document.getElementById('onboard').classList.add('hidden');
  projectMaterials=JSON.parse(JSON.stringify(DEFAULT_MATERIALS));
  buildDash();
  switchView('dash');
}

// =========== MAP ===========
function initMap(){
  map=L.map('map',{zoomControl:true}).setView([33.2,-96.7],10);
  setTile('terrain');
  routeLayerGroup=L.layerGroup().addTo(map);
}

function setTile(name){
  if(currentTileLayer) map.removeLayer(currentTileLayer);
  const t=TILES[name];
  currentTileLayer=L.tileLayer(t.url,{attribution:t.attr,maxZoom:19}).addTo(map);
  document.querySelectorAll('.layer-btn').forEach(b=>b.classList.toggle('active',b.dataset.layer===name));
}

function render(){
  document.getElementById('onboard').classList.add('hidden');
  const totalFt=routes.features.reduce((s,f)=>s+(f.properties.length_ft||0),0);
  document.getElementById('sRoutes').textContent=fmt(routes.features.length);
  document.getElementById('sLength').textContent=fmt(totalFt/5280)+' mi';
  document.getElementById('sHH').textContent=fmt(structures.features.length);
  if(dataSources.length&&dataSources[0].routes.length){
    document.getElementById('projName').value=dataSources[0].name.replace(/\.(kmz|kml)$/i,'');
  }
  drawRoutes(); fitBounds(); buildSidebar(); buildDash();
}

function drawRoutes(){
  routeLayerGroup.clearLayers();
  if(structureLayer){map.removeLayer(structureLayer);structureLayer=null;}
  let vis=0;
  routes.features.forEach((f,i)=>{
    if(!isVisible(f))return; vis++;
    const fc=f.properties.fiber_count;
    const color=FIBER_COLORS[fc]||'#64748b';
    L.geoJSON(f,{
      style:{color,weight:3,opacity:.85},
      onEachFeature:(_,l)=>{
        const p=f.properties;
        let pop=`<b>${p.name}</b><br>`;
        if(p.source)pop+=`<span style="color:var(--text-muted)">Source: ${p.source}</span><br>`;
        if(p.cable_type)pop+=p.cable_type+' &middot; ';
        if(p.fiber_count)pop+=p.fiber_count+'F &middot; ';
        pop+=fmt(p.length_ft)+' ft';
        l.bindPopup(pop);
      }
    }).addTo(routeLayerGroup);
  });
  document.getElementById('sVisible').textContent=fmt(vis);
  if(document.getElementById('chkHH').checked)toggleHH();
}

function isVisible(f){
  if(f.properties.route_type==='conduit'){const cb=document.querySelector(`[data-duct="${f.properties.duct_ways}"]`);if(cb&&!cb.checked)return false;}
  if(f.properties.fiber_count){const cb=document.querySelector(`[data-fc="${f.properties.fiber_count}"]`);if(cb&&!cb.checked)return false;}
  return true;
}

function fitBounds(){
  if(!routes.features.length)return;
  let a=90,b=-90,c=180,d=-180;
  routes.features.forEach(f=>f.geometry.coordinates.forEach(p=>{if(p[1]<a)a=p[1];if(p[1]>b)b=p[1];if(p[0]<c)c=p[0];if(p[0]>d)d=p[0];}));
  map.fitBounds([[a,c],[b,d]],{padding:[20,20]});
}

function toggleHH(){
  const show=document.getElementById('chkHH').checked;
  if(show&&structures.features.length){
    if(structureLayer)map.removeLayer(structureLayer);
    structureLayer=L.geoJSON(structures,{
      pointToLayer:(f,ll)=>L.circleMarker(ll,{
        radius:f.properties.type==='cabinet'?6:3,
        fillColor:f.properties.type==='cabinet'?'#dc2626':'#d97706',
        color:'white',weight:1,fillOpacity:.85
      }),
      onEachFeature:(f,l)=>l.bindPopup(`<b>${f.properties.name}</b><br>${f.properties.type}${f.properties.source?'<br><span style="color:var(--text-muted)">'+f.properties.source+'</span>':''}`)
    }).addTo(map);
  }else if(structureLayer){map.removeLayer(structureLayer);structureLayer=null;}
}

// =========== SIDEBAR ===========
function buildSidebar(){ recalcSidebar(); buildFilters(); buildLegend(); }

function recalcSidebar(){
  const div=document.getElementById('matsSummary');div.innerHTML='';
  const cols=getCols();
  const slack=document.getElementById('chkSlack').checked?structures.features.length*parseInt(document.getElementById('selSlack').value):0;
  const waste=document.getElementById('chkWaste').checked?parseFloat(document.getElementById('selWaste').value):0;
  const rows=[];
  if(cols.ducts.length){
    let tot=0;
    cols.ducts.forEach(d=>{let v=0;quarterly.forEach(q=>{v+=parseFloat(q[d.key]||0);});v*=(1+waste);tot+=v;rows.push({l:d.label,v:fmt(v)+' ft'});});
    rows.push({l:'Total Duct',v:fmt(tot)+' ft',b:true});
    rows.push({sep:true});
  }
  let totC=0;
  if(cols.cables.length) cols.cables.forEach(c=>{let v=0;quarterly.forEach(q=>{v+=parseFloat(q[c.key]||0);});totC+=v;rows.push({l:c.label,v:fmt(v)+' ft'});});
  if(cols.fibers.length) cols.fibers.forEach(f=>{let v=0;quarterly.forEach(q=>{v+=parseFloat(q[f.key]||0);});totC+=v;rows.push({l:f.label,v:fmt(v)+' ft'});});
  if(slack){totC+=slack;rows.push({l:'Slack',v:fmt(slack)+' ft'});}
  rows.push({l:'Total Cable',v:fmt(totC)+' ft',b:true});
  rows.push({sep:true});
  const cabs=structures.features.filter(f=>f.properties.type==='cabinet').length;
  const hhs=structures.features.length-cabs;
  if(cabs)rows.push({l:'OLT Cabinets',v:String(cabs)});
  rows.push({l:'Handholes',v:fmt(hhs)});
  rows.push({l:'Total Structures',v:fmt(structures.features.length),b:true});
  rows.forEach(r=>{
    if(r.sep){const d=document.createElement('div');d.className='sep';d.style.margin='6px 0';div.appendChild(d);return;}
    const el=document.createElement('div');el.className='stat';
    if(r.b)el.style.fontWeight='600';
    el.innerHTML=`<span>${r.l}</span><span class="val">${r.v}</span>`;
    div.appendChild(el);
  });
}

function buildFilters(){
  const ffDiv=document.getElementById('filterFiber');ffDiv.innerHTML='';
  const fcs=[...new Set(routes.features.filter(f=>f.properties.fiber_count).map(f=>f.properties.fiber_count))].sort((a,b)=>a-b);
  fcs.forEach(fc=>{
    const totalFt=routes.features.filter(f=>f.properties.fiber_count===fc).reduce((s,f)=>s+(f.properties.length_ft||0),0);
    const ct=routes.features.find(f=>f.properties.fiber_count===fc&&f.properties.cable_type)?.properties.cable_type;
    const lbl=ct?`${fc}F (${ct})`:`${fc}F`;
    const el=document.createElement('div');el.className='chk';
    el.innerHTML=`<input type="checkbox" checked data-fc="${fc}" onchange="drawRoutes()"><label>${lbl}</label><span class="ft">${fmt(totalFt)} ft</span>`;
    ffDiv.appendChild(el);
  });
  const fdDiv=document.getElementById('filterDuct');fdDiv.innerHTML='';
  const ducts=[...new Set(routes.features.filter(f=>f.properties.duct_ways).map(f=>f.properties.duct_ways))].sort((a,b)=>a-b);
  if(ducts.length){
    ducts.forEach(w=>{
      const totalFt=routes.features.filter(f=>f.properties.duct_ways===w).reduce((s,f)=>s+(f.properties.length_ft||0),0);
      const el=document.createElement('div');el.className='chk';
      el.innerHTML=`<input type="checkbox" checked data-duct="${w}" onchange="drawRoutes()"><label>${w}-way</label><span class="ft">${fmt(totalFt)} ft</span>`;
      fdDiv.appendChild(el);
    });
  }else{ fdDiv.innerHTML='<div style="color:var(--text-muted);font-size:11px">No conduit data</div>'; }
}

function buildLegend(){
  const div=document.getElementById('legend');div.innerHTML='';
  const fcs=[...new Set(routes.features.filter(f=>f.properties.fiber_count).map(f=>f.properties.fiber_count))].sort((a,b)=>a-b);
  fcs.forEach(fc=>{
    const ct=routes.features.find(f=>f.properties.fiber_count===fc&&f.properties.cable_type)?.properties.cable_type;
    const lbl=ct?`${fc}F ${ct}`:`${fc}F`;
    const el=document.createElement('div');el.className='legend-row';
    el.innerHTML=`<div class="legend-dot" style="background:${FIBER_COLORS[fc]||'#64748b'}"></div>${lbl}`;
    div.appendChild(el);
  });
}

// =========== DASHBOARD (CATALOG) ===========
function buildDash(){
  // Filter bar
  const filterBar=document.getElementById('dashFilterBar');
  filterBar.innerHTML=`<div class="filter-bar">
    <label><input type="checkbox" ${hideZeros?'checked':''} onchange="hideZeros=this.checked;buildDash()"> Hide zero-quantity items</label>
    <span style="flex:1"></span>
    <span style="font-size:12px;color:var(--text-muted)">All quantities and costs are editable</span>
  </div>`;

  const container=document.getElementById('materialsCatalog');
  container.innerHTML='';
  let grandTotal=0;

  Object.entries(projectMaterials).forEach(([catKey,category])=>{
    const isCollapsed=collapsedCats[catKey]||false;
    const visibleItems=hideZeros?category.items.filter(it=>it.qty>0):category.items;
    const allItems=category.items;

    let catSubtotal=0;
    allItems.forEach(it=>{catSubtotal+=it.qty*(it.currentCost!==undefined?it.currentCost:it.defaultCost);});
    grandTotal+=catSubtotal;

    const itemCount=allItems.filter(it=>it.qty>0).length;
    const section=document.createElement('div');
    section.className='dash-section';

    let h=`<div class="cat-header" onclick="toggleCat('${catKey}')">
      <span class="cat-toggle-icon ${isCollapsed?'collapsed':''}">&#9660;</span>
      <div class="dash-section-title" style="color:${category.color||'var(--text)'};margin-bottom:0;flex:1;">
        ${category.label}
        <span style="font-size:12px;font-weight:400;color:var(--text-muted);margin-left:8px;">${itemCount} item${itemCount!==1?'s':''} with qty</span>
        <span class="line"></span>
        <span style="font-size:13px;color:var(--accent);font-weight:700;">${fmtC(catSubtotal)}</span>
      </div>
    </div>`;

    if(!isCollapsed){
      h+=`<div style="overflow-x:auto;margin-top:8px;">
        <table class="cat-table">
          <thead><tr>
            <th style="width:35%">Material</th>
            <th style="width:8%;text-align:center">Unit</th>
            <th style="width:17%;text-align:right">Quantity</th>
            <th style="width:17%;text-align:right">Unit Cost ($)</th>
            <th style="width:23%;text-align:right">Extended Cost</th>
          </tr></thead>
          <tbody>`;

      const items=hideZeros?visibleItems:allItems;
      if(items.length===0){
        h+=`<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:12px;font-size:12px;">No items with quantities &mdash; uncheck "Hide zero-quantity" to see all ${allItems.length} items</td></tr>`;
      }
      items.forEach(item=>{
        const cost=item.currentCost!==undefined?item.currentCost:item.defaultCost;
        const extended=item.qty*cost;
        const hasQty=item.qty>0;
        h+=`<tr class="${hasQty?'has-qty':''}" data-item-id="${item.id}">
          <td class="row-label">${item.name}</td>
          <td class="unit-col">${item.unit}</td>
          <td style="text-align:right"><input type="number" class="editable-qty" value="${item.qty}" min="0" step="any" data-cat="${catKey}" data-id="${item.id}" data-field="qty" onchange="updateMaterialField(this)"></td>
          <td style="text-align:right"><input type="number" class="editable-qty" value="${cost.toFixed(2)}" min="0" step="0.01" data-cat="${catKey}" data-id="${item.id}" data-field="cost" onchange="updateMaterialField(this)"></td>
          <td class="ext-col" id="ext_${item.id}">${fmtC(extended)}</td>
        </tr>`;
      });

      h+=`</tbody>
        <tfoot><tr>
          <td colspan="4" style="text-align:right;padding-right:12px;font-weight:700;">Category Subtotal</td>
          <td style="text-align:right;color:var(--accent);font-weight:700;" id="subtotal_${catKey}">${fmtC(catSubtotal)}</td>
        </tr></tfoot>
      </table></div>`;
    }

    section.innerHTML=h;
    container.appendChild(section);
  });

  const bar=document.getElementById('budgetSummary');
  bar.innerHTML=`<div class="total-budget-bar" style="margin-top:24px;">
    <span class="budget-label">Grand Total Project Budget</span>
    <span class="budget-amount" id="grandTotal">${fmtC(grandTotal)}</span>
  </div>`;
}

function toggleCat(catKey){
  collapsedCats[catKey]=!collapsedCats[catKey];
  buildDash();
}

function updateMaterialField(el){
  const catKey=el.dataset.cat;
  const itemId=el.dataset.id;
  const field=el.dataset.field;
  const value=parseFloat(el.value)||0;
  const item=projectMaterials[catKey]?.items.find(it=>it.id===itemId);
  if(!item)return;
  if(field==='qty') item.qty=value;
  else if(field==='cost') item.currentCost=value;

  const cost=item.currentCost!==undefined?item.currentCost:item.defaultCost;
  const extended=item.qty*cost;
  const extEl=document.getElementById('ext_'+item.id);
  if(extEl) extEl.textContent=fmtC(extended);

  // Update row highlight
  const row=el.closest('tr');
  if(row){ row.classList.toggle('has-qty',item.qty>0); }

  // Recalculate category subtotal
  let catSub=0;
  projectMaterials[catKey].items.forEach(it=>{catSub+=it.qty*(it.currentCost!==undefined?it.currentCost:it.defaultCost);});
  const subEl=document.getElementById('subtotal_'+catKey);
  if(subEl) subEl.textContent=fmtC(catSub);

  // Recalculate grand total
  let gt=0;
  Object.values(projectMaterials).forEach(cat=>{cat.items.forEach(it=>{gt+=it.qty*(it.currentCost!==undefined?it.currentCost:it.defaultCost);});});
  const gtEl=document.getElementById('grandTotal');
  if(gtEl) gtEl.textContent=fmtC(gt);
}

// =========== COMPARE ===========
function buildCompare(){
  const div=document.getElementById('compareContent');
  if(dataSources.length<1){
    div.innerHTML='<p style="color:var(--text-muted);font-size:14px;">Upload files to see data here. Add multiple sources to compare materials across them.</p>';
    return;
  }
  const srcColors=['#2563eb','#059669','#d97706','#7c3aed','#dc2626','#0d9488','#e67e22','#e91e63'];
  let h='';

  // Source summary cards
  h+='<div class="cost-grid" style="margin-bottom:24px">';
  dataSources.forEach((src,i)=>{
    const matCount=Object.keys(src.materials).length;
    const color=srcColors[i%srcColors.length];
    h+=`<div class="card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <div style="width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0;"></div>
        <div class="card-title" style="margin:0;">${src.name}</div>
      </div>
      <div class="card-row"><span class="lbl">Type</span><span class="val">${src.type.toUpperCase()}</span></div>
      <div class="card-row"><span class="lbl">Routes</span><span class="val">${fmt(src.routes.length)}</span></div>
      <div class="card-row"><span class="lbl">Structures</span><span class="val">${fmt(src.structures.length)}</span></div>
      <div class="card-row"><span class="lbl">Material Items</span><span class="val">${matCount}</span></div>
    </div>`;
  });
  h+='</div>';

  // Build comparison by catalog category
  Object.entries(DEFAULT_MATERIALS).forEach(([catKey,category])=>{
    const rowsHtml=[];
    category.items.forEach(item=>{
      const vals=dataSources.map(src=>{
        let srcQty=0;
        Object.entries(src.materials).forEach(([key,qty])=>{
          if(resolveToMaterialId(key)===item.id) srcQty+=qty;
        });
        return srcQty;
      });
      const total=vals.reduce((s,v)=>s+v,0);
      if(total===0) return;
      let row=`<tr><td class="row-label">${item.name}</td><td style="color:var(--text-muted);font-size:11px">${item.unit}</td>`;
      vals.forEach(v=>{ row+=`<td class="src-val">${v>0?fmt(v):'\u2014'}</td>`; });
      row+=`<td class="src-val" style="font-weight:700">${fmt(total)}</td></tr>`;
      rowsHtml.push(row);
    });

    if(rowsHtml.length===0) return;

    h+=`<div class="dash-section">
      <div class="dash-section-title" style="color:${category.color}">${category.label}<span class="line"></span></div>
      <table class="compare-table"><thead><tr><th>Material</th><th>Unit</th>`;
    dataSources.forEach((src,i)=>{ h+=`<th style="text-align:right"><span class="source-chip" style="background:${srcColors[i%srcColors.length]}11;color:${srcColors[i%srcColors.length]}">${src.name.substring(0,20)}</span></th>`; });
    h+='<th style="text-align:right;font-weight:700">Total</th></tr></thead><tbody>';
    h+=rowsHtml.join('');
    h+='</tbody></table></div>';
  });

  // Unmapped materials
  const allKeys=new Set();
  dataSources.forEach(src=>Object.keys(src.materials).forEach(k=>allKeys.add(k)));
  const unmappedKeys=[...allKeys].filter(k=>!resolveToMaterialId(k)&&k!=='Structures');
  if(unmappedKeys.length){
    h+=`<div class="dash-section">
      <div class="dash-section-title" style="color:var(--text-muted)">Unmapped / Custom Materials<span class="line"></span></div>
      <table class="compare-table"><thead><tr><th>Material</th><th></th>`;
    dataSources.forEach((src,i)=>{ h+=`<th style="text-align:right">${src.name.substring(0,20)}</th>`; });
    h+='<th style="text-align:right;font-weight:700">Total</th></tr></thead><tbody>';
    unmappedKeys.sort().forEach(key=>{
      const vals=dataSources.map(src=>src.materials[key]||0);
      const total=vals.reduce((s,v)=>s+v,0);
      h+=`<tr><td class="row-label">${key}</td><td></td>`;
      vals.forEach(v=>{h+=`<td class="src-val">${v>0?fmt(v):'\u2014'}</td>`;});
      h+=`<td class="src-val" style="font-weight:700">${fmt(total)}</td></tr>`;
    });
    h+='</tbody></table></div>';
  }

  if(dataSources.length<2){
    h+='<p style="color:var(--text-muted);font-size:12px;margin-top:12px;">Add more files to see a side-by-side comparison.</p>';
  }

  div.innerHTML=h;
}

// =========== EXPORT ===========
function doExport(){
  const data={
    projectName:document.getElementById('projName').value,
    projectType:pType,
    materials:projectMaterials,
    routes,structures,quarterly,
    dataSources:dataSources.map(s=>({name:s.name,type:s.type,materials:s.materials}))
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=(document.getElementById('projName').value||'project')+'-export.json';a.click();
}

function openDropbox(){document.getElementById('dbxModal').classList.add('open');}
async function loadDropbox(){
  let url=document.getElementById('dbxUrl').value.trim();if(!url)return;
  url=url.replace('dl=0','dl=1').replace('www.dropbox.com','dl.dropboxusercontent.com');
  document.getElementById('dbxModal').classList.remove('open');
  toast('Loading from Dropbox...');
  try{
    const resp=await fetch(url);const blob=await resp.blob();
    const name=url.split('/').pop().split('?')[0]||'file';
    const f=new File([blob],name);
    await processFile(f);
    mergeAllSources();
    render();
  }catch(err){toast('Dropbox error: '+err.message,'error');}
}

// =========== EVENTS ===========
const dz=document.getElementById('dropzone');
dz.addEventListener('click',()=>document.getElementById('fileInput').click());
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');queueFiles(e.dataTransfer.files);});
document.getElementById('fileInput').addEventListener('change',e=>{queueFiles(e.target.files);e.target.value='';});

document.body.addEventListener('dragover',e=>e.preventDefault());
document.body.addEventListener('drop',e=>{
  e.preventDefault();
  if(!document.getElementById('onboard').classList.contains('hidden')) queueFiles(e.dataTransfer.files);
  else for(const f of e.dataTransfer.files) addMoreFiles([f]);
});

// =========== INIT ===========
initMap();
</script>
</body>
</html>
